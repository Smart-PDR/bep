<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEB Profesyonel BEP Asistanı v10.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        mebRed: '#e11d48', 
                        mebBlue: '#1d4ed8',
                        mebYellow: '#f59e0b',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Özel Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Animasyonlar */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .checkbox-wrapper:checked + div {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }
        
        /* Accordion Animasyonu */
        .accordion-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease-out;
        }
        .accordion-wrapper.open {
            grid-template-rows: 1fr;
        }
        .accordion-content {
            overflow: hidden;
        }

        /* Multi-Select Dropdown Stilleri */
        .multi-select-dropdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .multi-select-dropdown.open {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }
        
        /* Zorunlu Alan Hatası */
        .input-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
            animation: shake 0.3s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* YAZDIRMA STİLLERİ */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-family: 'Times New Roman', serif; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .page-break { page-break-after: always; display: block; position: relative; }
            
            /* Genel Düzen */
            .bep-page-container {
                padding-bottom: 20px;
            }

            /* Başlık Alanı */
            .header-section {
                text-align: center;
                border-bottom: 2px solid #333;
                margin-bottom: 20px;
                padding-bottom: 10px;
            }
            .header-main { font-size: 12pt; font-weight: bold; }
            .header-sub { font-size: 14pt; font-weight: bold; margin-top: 5px; }
            .header-lesson { font-size: 11pt; margin-top: 5px; font-style: italic; }

            /* Tablolar */
            table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 15px; }
            th, td { border: 1px solid #444; padding: 6px 8px; text-align: left; vertical-align: top; }
            th { background-color: #f3f4f6 !important; font-weight: bold; text-align: center; color: #111; }
            
            /* Bilgi Tablosu */
            .info-table th { width: 18%; background-color: #e5e7eb !important; text-align: left; }
            
            /* Hedefler Tablosu */
            .goals-table th { background-color: #374151 !important; color: white !important; padding: 8px; }
            .goals-table td { padding: 8px; }
            
            /* Eğitsel Performans Kutusu */
            .perf-box {
                border: 1px solid #444;
                margin-bottom: 20px;
                border-radius: 4px;
                overflow: hidden;
            }
            .perf-header {
                background-color: #e5e7eb;
                padding: 6px;
                font-weight: bold;
                text-align: center;
                border-bottom: 1px solid #444;
                font-size: 10pt;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            .perf-content {
                padding: 10px;
                font-size: 10pt;
                line-height: 1.5;
                text-align: justify;
            }

            /* İmza Bölümü */
            .imza-bolumu { 
                margin-top: 30px; 
                width: 100%; 
                break-inside: avoid;
            }
            .imza-table { border: none !important; width: 100%; }
            .imza-table td { 
                border: none !important; 
                height: 80px; 
                vertical-align: top; 
                text-align: center; 
                width: 25%; 
                font-size: 10pt;
            }
            .imza-isim {
                font-weight: bold;
                margin-bottom: 5px;
                display: block;
            }
            .imza-unvan {
                font-size: 9pt;
                font-style: italic;
                display: block;
                color: #444;
            }
            .imza-cizgi {
                border-top: 1px solid #aaa;
                width: 80%;
                margin: 40px auto 0 auto;
            }
        }
        
        .print-only { display: none; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- KARŞILAMA EKRANI -->
    <div id="welcomeOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center transition-all duration-500 no-print">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 relative overflow-hidden border border-slate-200 fade-in">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-mebRed via-mebBlue to-mebYellow"></div>

            <div class="text-center mb-6 mt-2">
                <div class="inline-block p-3 bg-slate-50 rounded-full mb-3 shadow-sm">
                    <i class="fas fa-book-reader text-3xl text-mebRed"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">MEB BEP Asistanı v10.3</h1>
                <p class="text-slate-500 text-sm">Hızlı, Kolay ve Mevzuata Uygun BEP Hazırlayın</p>
            </div>

            <div class="space-y-4 mb-8">
                <div class="flex items-start gap-4 p-3 bg-slate-50 rounded-lg border border-slate-100">
                    <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0 text-sm shadow-sm">1</div>
                    <div>
                        <h4 class="font-bold text-slate-700 text-sm">Bilgileri Girin</h4>
                        <p class="text-xs text-slate-500">Öğrenci, kurul ve performans bilgilerini doldurun.</p>
                    </div>
                </div>
                 <div class="flex items-start gap-4 p-3 bg-slate-50 rounded-lg border border-slate-100">
                    <div class="bg-red-100 text-red-600 w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0 text-sm shadow-sm">2</div>
                    <div>
                        <h4 class="font-bold text-slate-700 text-sm">Hedefleri Belirleyin</h4>
                        <p class="text-xs text-slate-500">Müfredattan ders ve UDA seçin, KDA'ları ekleyin.</p>
                    </div>
                </div>
                 <div class="flex items-start gap-4 p-3 bg-slate-50 rounded-lg border border-slate-100">
                    <div class="bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0 text-sm shadow-sm">3</div>
                    <div>
                        <h4 class="font-bold text-slate-700 text-sm">Planı Oluşturun</h4>
                        <p class="text-xs text-slate-500">Otomatik işlemlerle planı tamamlayın ve yazdırın.</p>
                    </div>
                </div>
            </div>

            <button onclick="uygulamayiBaslat()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-1 group">
                Başla <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>
    </div>
    
    <!-- KILAVUZ MODAL -->
    <div id="kilavuzModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[200] hidden items-center justify-center no-print">
        <div class="bg-white w-full max-w-6xl h-auto max-h-[90vh] rounded-2xl shadow-2xl flex flex-col relative fade-in mx-4">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-slate-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                     <div class="bg-slate-800 text-white p-2 rounded-lg"><i class="fas fa-info-circle text-xl"></i></div>
                     <div>
                         <h2 class="text-xl font-bold text-slate-800">BEP Hazırlama Kılavuzu</h2>
                         <p class="text-xs text-slate-500">Adım adım profesyonel BEP hazırlama süreci</p>
                     </div>
                </div>
                <button onclick="document.getElementById('kilavuzModal').classList.add('hidden')" class="text-slate-400 hover:text-red-600 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="overflow-y-auto p-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Adım 1 -->
                    <div class="flex flex-col h-full bg-slate-50 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="p-4 bg-mebBlue/10 border-b border-slate-200 rounded-t-xl flex items-center gap-3">
                            <span class="bg-mebBlue text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-sm">1</span>
                            <h3 class="font-bold text-mebBlue">Öğrenci & Kurul</h3>
                        </div>
                        <div class="p-5 text-sm text-slate-600 space-y-3 leading-relaxed flex-grow">
                            <p><strong><i class="fas fa-exclamation-circle text-mebRed mr-1"></i>Zorunlu Alanlar:</strong> Okul, öğrenci adı, sınıf ve kurul üyeleri alanları yazdırma işleminden önce mutlaka doldurulmalıdır.</p>
                            <p><strong>Tanı Seçimi:</strong> RAM raporuna uygun tanıyı seçin. Listede yoksa "Diğer" ile manuel giriş yapın.</p>
                            <p><strong>Performans:</strong> Hedefleri ekledikten sonra <strong>'Otomatik'</strong> butonunu kullanarak sistemin profesyonel bir performans yazısı oluşturmasını sağlayın.</p>
                        </div>
                    </div>

                    <!-- Adım 2 -->
                    <div class="flex flex-col h-full bg-slate-50 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="p-4 bg-mebRed/10 border-b border-slate-200 rounded-t-xl flex items-center gap-3">
                            <span class="bg-mebRed text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-sm">2</span>
                            <h3 class="font-bold text-mebRed">Hedef & Yöntem</h3>
                        </div>
                        <div class="p-5 text-sm text-slate-600 space-y-3 leading-relaxed flex-grow">
                             <p><strong>Müfredat:</strong> Sınıf ve ders seçimi sonrası UDA'lar listelenir. <strong>Aynı UDA'yı aynı derse iki kez ekleyemezsiniz.</strong></p>
                             <p><strong>Özelleştirme:</strong> Detay ayarlarından yöntem, teknik ve araç-gereçleri çoklu seçimle belirleyebilirsiniz.</p>
                             <p><strong>Ekleme:</strong> Seçimleri tamamladıktan sonra "BEP Planına Ekle" butonu ile hedefi sağ panele aktarın.</p>
                        </div>
                    </div>

                    <!-- Adım 3 -->
                    <div class="flex flex-col h-full bg-slate-50 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="p-4 bg-mebYellow/20 border-b border-slate-200 rounded-t-xl flex items-center gap-3">
                            <span class="bg-mebYellow text-black w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-sm">3</span>
                            <h3 class="font-bold text-slate-800">Kontrol & Çıktı</h3>
                        </div>
                        <div class="p-5 text-sm text-slate-600 space-y-3 leading-relaxed flex-grow">
                            <p><strong>Kontrol:</strong> Sağ panelden eklenen hedefleri inceleyin, gerekirse silin veya düzenleyin.</p>
                            <p><strong>Yedekleme:</strong> Çalışmanızı .json formatında kaydedip daha sonra tekrar yükleyebilirsiniz.</p>
                            <p><strong>Yazdırma:</strong> Tüm zorunlu alanlar doluysa "Yazdır" butonu her ders için ayrı sayfalanmış resmi formatı oluşturur.</p>
                        </div>
                    </div>

                </div>
            </div>
            
            <div class="p-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl text-center">
                <button onclick="document.getElementById('kilavuzModal').classList.add('hidden')" class="px-8 py-2.5 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900 transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5">Anlaşıldı, Başlayalım</button>
            </div>
        </div>
    </div>

    <!-- Toast Bildirim -->
    <div id="toast" class="fixed top-5 right-5 bg-green-600 text-white px-6 py-4 rounded-lg shadow-xl transform -translate-y-24 opacity-0 transition-all duration-300 z-[999] flex items-center gap-3">
        <i class="fas fa-check-circle text-2xl"></i>
        <div>
            <h4 class="font-bold text-sm">Başarılı</h4>
            <p class="text-xs" id="toastMessage">İşlem tamamlandı.</p>
        </div>
    </div>
    
    <input type="file" id="jsonFileInput" accept=".json" class="hidden" onchange="dosyadanYukle(this)">

    <!-- ANA EKRAN (NO PRINT) -->
    <div class="no-print min-h-screen flex flex-col bg-slate-100">
        
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
            <div class="max-w-[1400px] mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-mebRed text-white p-2 rounded-lg shadow-md">
                        <i class="fas fa-book-reader text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg text-slate-800 leading-tight">MEB BEP Asistanı v10.3</h1>
                        <p class="text-[10px] text-slate-500 font-medium">Profesyonel Sürüm</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('kilavuzModal').classList.remove('hidden')" class="px-3 py-2 text-sm font-medium text-mebBlue bg-blue-50 hover:bg-blue-100 rounded-lg transition border border-blue-200 flex items-center gap-2">
                        <i class="fas fa-question-circle"></i> <span class="hidden sm:inline">Nasıl Kullanılır?</span>
                    </button>
                    <div class="h-8 w-px bg-slate-200 mx-1"></div>
                    <button onclick="verileriYedekle()" class="px-3 py-2 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition hidden md:block" title="Bilgisayara Kaydet">
                        <i class="fas fa-download mr-1"></i> Yedekle
                    </button>
                    <button onclick="document.getElementById('jsonFileInput').click()" class="px-3 py-2 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition hidden md:block" title="Yedekten Yükle">
                        <i class="fas fa-upload mr-1"></i> Yükle
                    </button>
                    <button onclick="verileriTemizle()" class="px-3 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition border border-red-200">
                        <i class="fas fa-trash-alt mr-1"></i> Yeni
                    </button>
                    <button onclick="tamamlaVeYazdirKontrol()" class="px-4 py-2 text-sm font-bold text-white bg-mebRed hover:bg-red-700 rounded-lg shadow-md hover:shadow-lg transition flex items-center gap-2">
                        <i class="fas fa-print"></i> Yazdır
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow w-full max-w-[1400px] mx-auto p-4 sm:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- SOL KOLON: ADIM 1 -->
            <div class="lg:col-span-4 flex flex-col gap-4">
                
                <!-- ADIM 1 BAŞLIĞI -->
                <div class="flex items-center gap-3 pb-2 border-b-2 border-mebBlue/30">
                    <div class="w-8 h-8 rounded-lg bg-mebBlue text-white flex items-center justify-center font-bold text-sm shadow-sm">1</div>
                    <h2 class="font-bold text-slate-700 text-lg uppercase tracking-tight">Öğrenci & Kurul</h2>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                        <h3 class="font-bold text-slate-700 text-sm"><i class="fas fa-user-graduate text-mebBlue mr-2"></i>Kimlik Bilgileri</h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Okul Adı <span class="text-red-500">*</span></label>
                            <input type="text" id="okulAd" class="w-full text-sm border-slate-300 rounded-lg focus:ring-mebRed focus:border-mebRed transition-all" placeholder="Örn: Cumhuriyet İlkokulu">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Öğrenci Adı Soyadı <span class="text-red-500">*</span></label>
                            <input type="text" id="ogrAd" class="w-full text-sm border-slate-300 rounded-lg focus:ring-mebRed focus:border-mebRed transition-all" placeholder="Örn: Ali Yılmaz">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Sınıf <span class="text-red-500">*</span></label>
                                <input type="text" id="ogrSinif" class="w-full text-sm border-slate-300 rounded-lg transition-all" placeholder="Örn: 3/A">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Numara</label>
                                <input type="text" id="ogrNo" class="w-full text-sm border-slate-300 rounded-lg transition-all" placeholder="123">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Eğitsel Tanı <span class="text-red-500">*</span></label>
                            <select id="taniSecimi" onchange="toggleManualInput('taniSecimi', 'taniManuel')" class="w-full text-sm border-slate-300 rounded-lg mb-2 transition-all">
                                <option value="">Tanı Seçiniz...</option>
                                <option value="Özgül Öğrenme Güçlüğü">Özgül Öğrenme Güçlüğü</option>
                                <option value="Hafif Düzey Zihinsel Yetersizlik">Hafif Düzey Zihinsel Yetersizlik</option>
                                <option value="Orta Düzey Zihinsel Yetersizlik">Orta Düzey Zihinsel Yetersizlik</option>
                                <option value="Otizm Spektrum Bozukluğu (OSB)">Otizm Spektrum Bozukluğu (OSB)</option>
                                <option value="Dikkat Eksikliği ve Hiperaktivite Bozukluğu (DEHB)">Dikkat Eksikliği ve Hiperaktivite (DEHB)</option>
                                <option value="Dil ve Konuşma Güçlüğü">Dil ve Konuşma Güçlüğü</option>
                                <option value="İşitme Yetersizliği">İşitme Yetersizliği</option>
                                <option value="Görme Yetersizliği">Görme Yetersizliği</option>
                                <option value="Bedensel Yetersizlik">Bedensel Yetersizlik</option>
                                <option value="Diğer">Diğer (Elle Giriniz)</option>
                            </select>
                            <input type="text" id="taniManuel" class="hidden w-full text-sm border-slate-300 rounded-lg border-2 border-red-200" placeholder="Tanıyı yazınız...">
                        </div>
                        
                        <!-- Tarih -->
                        <div class="bg-blue-50 p-2 rounded border border-blue-100">
                             <div class="flex justify-between items-center mb-1">
                                 <label class="text-xs font-bold text-blue-700">BEP Tarih Aralığı</label>
                                 <button onclick="tarihAta('tam')" class="text-[10px] bg-white border border-blue-200 text-blue-600 px-2 py-0.5 rounded hover:bg-blue-100">Tüm Yıl</button>
                             </div>
                             <div class="flex gap-2">
                                 <input type="date" id="basTarih" class="w-full text-xs border-slate-300 rounded">
                                 <span class="self-center">-</span>
                                 <input type="date" id="bitTarih" class="w-full text-xs border-slate-300 rounded">
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Kurul Üyeleri (Accordion) -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors" onclick="toggleAccordion('kurulBody', 'kurulIcon')">
                         <h3 class="font-bold text-slate-700 text-sm flex justify-between items-center">
                             <span><i class="fas fa-users text-mebBlue mr-2"></i>Kurul Üyeleri <span class="text-red-500 text-xs ml-1">(Zorunlu)</span></span>
                             <i id="kurulIcon" class="fas fa-chevron-down text-xs text-slate-400 transition-transform duration-300"></i>
                         </h3>
                    </div>
                    <div id="kurulBody" class="accordion-wrapper">
                        <div class="accordion-content p-4 space-y-2 bg-white">
                            <div><input type="text" id="mudurAd" class="w-full text-xs border-slate-300 rounded focus:ring-mebBlue focus:border-mebBlue" placeholder="Birim Başkanı / Müdür *"></div>
                            <div><input type="text" id="rehberAd" class="w-full text-xs border-slate-300 rounded focus:ring-mebBlue focus:border-mebBlue" placeholder="Rehber Öğretmen *"></div>
                            <div><input type="text" id="sinifOgretmenAd" class="w-full text-xs border-slate-300 rounded focus:ring-mebBlue focus:border-mebBlue" placeholder="Sınıf Öğretmeni *"></div>
                            <div><input type="text" id="veliAd" class="w-full text-xs border-slate-300 rounded focus:ring-mebBlue focus:border-mebBlue" placeholder="Veli *"></div>
                        </div>
                    </div>
                </div>

                <!-- Performans -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-grow flex flex-col">
                    <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-sm"><i class="fas fa-chart-line text-mebBlue mr-2"></i>Eğitsel Performans</h3>
                        <button onclick="otomatikPerformansOlustur()" class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200 font-bold transition-colors">
                            <i class="fas fa-magic mr-1"></i> Otomatik
                        </button>
                    </div>
                    <div class="p-2 flex-grow">
                        <textarea id="ogrPerf" class="w-full h-full min-h-[100px] text-sm border-slate-300 rounded-lg resize-none focus:ring-mebRed focus:border-mebRed" placeholder="Öğrencinin performans düzeyi..."></textarea>
                    </div>
                </div>
            </div>

            <!-- ORTA KOLON: ADIM 2 -->
            <div class="lg:col-span-5 flex flex-col gap-4">

                <!-- ADIM 2 BAŞLIĞI -->
                <div class="flex items-center gap-3 pb-2 border-b-2 border-mebRed/30">
                    <div class="w-8 h-8 rounded-lg bg-mebRed text-white flex items-center justify-center font-bold text-sm shadow-sm">2</div>
                    <h2 class="font-bold text-slate-700 text-lg uppercase tracking-tight">Hedef Belirleme</h2>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 h-full flex flex-col">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200">
                        <h3 class="font-bold text-slate-700 text-sm"><i class="fas fa-bullseye text-mebRed mr-2"></i>Müfredat ve Kazanımlar</h3>
                    </div>
                    
                    <div class="p-4 space-y-4 flex-grow overflow-y-auto">
                        <!-- Ders Seçimi -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">Sınıf Düzeyi</label>
                                <select id="sinifSecimi" onchange="dersleriGetir()" class="w-full border-slate-300 rounded-lg text-sm bg-slate-50 focus:ring-2 focus:ring-mebRed focus:border-mebRed transition-all duration-200 hover:border-mebRed">
                                    <option value="">Seçiniz...</option>
                                    <option value="1">1. Sınıf</option>
                                    <option value="2">2. Sınıf</option>
                                    <option value="3">3. Sınıf</option>
                                    <option value="4">4. Sınıf</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">Ders</label>
                                <select id="dersSecimi" onchange="udalariGetir()" disabled class="w-full border-slate-300 rounded-lg text-sm bg-slate-50 disabled:opacity-50 focus:ring-2 focus:ring-mebRed focus:border-mebRed transition-all duration-200 hover:border-mebRed">
                                    <option value="">Önce sınıf...</option>
                                </select>
                            </div>
                        </div>

                        <!-- UDA Seçimi (Özel Vurgu ile) -->
                        <div id="udaContainer" class="accordion-wrapper">
                             <div class="accordion-content">
                                <label class="block text-xs font-bold text-mebBlue mb-1 flex items-center gap-2">
                                    <i class="fas fa-crosshairs"></i> Uzun Dönemli Amaç (UDA)
                                </label>
                                <div class="p-1 bg-blue-50/50 rounded-lg border border-blue-100">
                                    <select id="udaSecimi" onchange="kdalariGetir()" class="w-full text-sm border-blue-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all py-2">
                                        <option value="">Hedef seçiniz...</option>
                                    </select>
                                    <input type="text" id="udaManuel" class="hidden w-full text-sm border-blue-300 rounded-lg bg-white placeholder-slate-400 mt-2" placeholder="Kendi hedefinizi yazınız...">
                                </div>
                             </div>
                        </div>

                        <!-- Detay Ayarları (Accordion Style) -->
                        <div id="detayAyarlari" class="accordion-wrapper border-t border-slate-100 mt-2">
                            <div class="accordion-content space-y-3 pt-3">
                                <!-- Öğretim Yöntemleri -->
                                <div class="relative">
                                    <label class="block text-xs font-bold text-slate-600 mb-1">Öğretim Yöntem ve Teknikleri</label>
                                    <button onclick="toggleDropdown('yontemDropdown')" class="w-full text-left text-xs bg-white border border-slate-300 rounded-lg px-3 py-2 flex justify-between items-center hover:border-mebBlue transition-colors">
                                        <span id="yontemOzet" class="truncate">Anlatım, Soru-Cevap (Varsayılan)</span>
                                        <i class="fas fa-chevron-down text-slate-400"></i>
                                    </button>
                                    <div id="yontemDropdown" class="multi-select-dropdown w-full bg-white shadow-md border border-slate-200 rounded-lg mt-1 z-10">
                                        <!-- JS ile doldurulacak -->
                                    </div>
                                </div>

                                <!-- Araç Gereçler -->
                                <div class="relative">
                                    <label class="block text-xs font-bold text-slate-600 mb-1">Eğitim Araç ve Gereçleri</label>
                                    <button onclick="toggleDropdown('aracDropdown')" class="w-full text-left text-xs bg-white border border-slate-300 rounded-lg px-3 py-2 flex justify-between items-center hover:border-mebBlue transition-colors">
                                        <span id="aracOzet" class="truncate">Ders Kitabı/Defter (Varsayılan)</span>
                                        <i class="fas fa-chevron-down text-slate-400"></i>
                                    </button>
                                    <div id="aracDropdown" class="multi-select-dropdown w-full bg-white shadow-md border border-slate-200 rounded-lg mt-1 z-10">
                                        <!-- JS ile doldurulacak -->
                                    </div>
                                </div>

                                <!-- Değerlendirme ve Ölçüt -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="relative">
                                        <label class="block text-xs font-bold text-slate-600 mb-1">Değerlendirme</label>
                                        <button onclick="toggleDropdown('degerlendirmeDropdown')" class="w-full text-left text-xs bg-white border border-slate-300 rounded-lg px-3 py-2 flex justify-between items-center hover:border-mebBlue transition-colors">
                                            <span id="degerlendirmeOzet" class="truncate">Gözlem Formu...</span>
                                            <i class="fas fa-chevron-down text-slate-400"></i>
                                        </button>
                                        <div id="degerlendirmeDropdown" class="multi-select-dropdown w-full bg-white shadow-md border border-slate-200 rounded-lg mt-1 z-10">
                                            <!-- JS ile doldurulacak -->
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-600 mb-1">Başarı Ölçütü</label>
                                        <select id="olcutSecimi" class="w-full text-xs border-slate-300 rounded-lg">
                                            <option value="%60">%60</option>
                                            <option value="%75">%75</option>
                                            <option value="%80">%80</option>
                                            <option value="%100">%100</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- KDA Seçimi -->
                        <div id="kdaContainer" class="accordion-wrapper flex-grow">
                             <div class="accordion-content flex flex-col h-full pt-2">
                                 <div class="flex justify-between items-center mb-1">
                                     <label class="text-xs font-bold text-slate-700">Kısa Dönemli Amaçlar (KDA)</label>
                                     <div class="flex items-center gap-1" id="tumunuSecContainer">
                                        <input type="checkbox" id="tumunuSec" onchange="tumKdaSec()" class="rounded text-mebRed focus:ring-mebRed w-3 h-3">
                                        <label for="tumunuSec" class="text-[10px] text-slate-500 cursor-pointer">Tümünü Seç</label>
                                     </div>
                                 </div>
                                 
                                 <!-- KDA Listesi Scroll Area -->
                                 <div class="border border-slate-200 rounded-lg bg-slate-50 p-2 overflow-y-auto max-h-[180px] min-h-[100px]" id="kdaListesi">
                                     <!-- Checkboxlar buraya gelecek -->
                                 </div>
                                 
                                 <!-- Manuel KDA Alanı (Sadece Manuel UDA seçilirse görünür) -->
                                 <textarea id="kdaManuel" class="hidden w-full h-[150px] text-sm border-slate-300 rounded-lg mt-2 p-2 focus:ring-mebRed" placeholder="Kısa dönemli amaçları her satıra bir tane gelecek şekilde yazınız..."></textarea>

                                 <button onclick="planaEkle()" class="w-full mt-3 bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 hover:-translate-y-0.5">
                                     <i class="fas fa-plus-circle"></i> BEP Planına Ekle
                                 </button>
                             </div>
                        </div>

                        <div id="bosMesaj" class="flex flex-col items-center justify-center text-slate-400 py-10 transition-opacity duration-300">
                            <i class="fas fa-mouse-pointer text-3xl mb-2 opacity-30"></i>
                            <span class="text-xs">Başlamak için Sınıf ve Ders seçin.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SAĞ KOLON: ADIM 3 -->
            <div class="lg:col-span-3 flex flex-col gap-4">

                <!-- ADIM 3 BAŞLIĞI -->
                <div class="flex items-center gap-3 pb-2 border-b-2 border-mebYellow/50">
                    <div class="w-8 h-8 rounded-lg bg-mebYellow text-black flex items-center justify-center font-bold text-sm shadow-sm">3</div>
                    <h2 class="font-bold text-slate-700 text-lg uppercase tracking-tight">Plan Özeti</h2>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 h-full flex flex-col">
                    <div class="p-4 border-b border-slate-100 bg-slate-50">
                          <h3 class="text-xs font-bold text-slate-700 mb-2 uppercase">Plan Dağılımı</h3>
                          <div id="istatistikKutusu" class="text-xs space-y-1">
                              <div class="text-slate-400 italic">Veri yok.</div>
                          </div>
                    </div>

                    <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-sm">Eklenen Hedefler</h3>
                        <span id="hedefSayisi" class="bg-mebRed text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                    </div>
                    
                    <div id="planListesi" class="p-3 flex-grow overflow-y-auto max-h-[500px] space-y-2">
                        <div class="text-center py-8 text-slate-400 text-xs italic">Henüz hedef eklenmedi.</div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- YAZDIRMA ALANI (PRINT ONLY) -->
    <div id="printArea" class="print-only"></div>

    <script>
        // --- VERİ SABİTLERİ ---
        const OGRETIM_YONTEMLERI = [
            "Anlatım Yöntemi", "Artan Bekleme Süreli Öğretim", "Aşamalı Yardımla Öğretim", "Ba Sa Ra Yöntemi", 
            "Bilgisayar Destekli Öğretim Yöntemi", "Davranışsal Beceri Öğretimi", "Demostrasyon", "Deney ve Laboratuvar Yöntemi", 
            "Doğrudan Öğretim Yöntemi", "Drama", "Eş Zamanlı İpucuyla Öğretim", "Etkinlik Çizelgeleriyle Öğretim", 
            "Etkinlik Temelli Öğretim", "Fırsat Öğretimi", "Gösterip Yaptırma Tekniği", "Grup Çalışması", "Güç Kartları", 
            "İpucu Sunma ve Geri Çekme İle Öğretim", "İpucunun Giderek Azaltılmasıyla Öğretim", "Model Olma", "Okuduğunu Anlama", 
            "Okuma ve Yazma Etkinlikleri", "Oyun", "Örnek Olay Öğretimi", "Problem Çözme Yöntemi", "Proje Yöntemi", 
            "Replikli Öğretim", "Sabit Bekleme Süreli Öğretim", "Sesletim ve Çözümleme", "Sınıf Dışı Öğretim Yöntemi (İnceleme, Gezi, Gözlem)", 
            "Soru Cevap Tekniği", "Söyle Yap Yöntemi", "Sözel ve Görsel İpucu", "Tekrarlı Okuma", "Video Modelle Öğretim", 
            "Yankılı Okuma", "Yanlışsız Öğretim Yöntemi"
        ];
        const DEGERLENDIRME_YONTEMLERI = [
            "Ayrık Deneme Kaydı", "Beceri Analiz Kaydı", "Çoktan Seçmeli Test", "Davranış Kayıt Formu", "Dikte", 
            "Ev Ödevleri", "Gözlem", "Kendini İzleme Formu", "Kısa Cevaplı Sınav", "Kontrol Listesi", "Öğrenci Gelişim Dosyası", 
            "Ölçüt Bağımlı Ölçü Aracı", "Sözlü Sınav", "Uygulamalı Sınav", "Yazılı Sınav"
        ];
        const ARAC_GERECLER = [
            "Bilmeceler", "Makara", "Abaküs", "Afiş", "Ahşap Bloklar", "Ahşap Rende", "Akıllı Tahta", "Amiral battı", 
            "Balon", "Bilgisayar", "Bilye", "Bisiklet", "Boncuk", "Bowling", "Boya", "Boya Kalemi", "Büyüteç", 
            "CAD/CAM Programı", "Cetvel", "Çalışma Kağıtları", "Çarpım Tablosu", "Çeşitli Sıvılar", "Çit", "Dama", 
            "Darbuka", "Defter", "Denge Tahtası", "Ders Kitabı", "Ders Modülleri", "Düğme", "Ebru Malzemeleri", 
            "Elementler Tablosu", "Eş bulma oyunları", "Fırça", "Fon kartonu", "Geometrik Cisimler Seti", "Gönye", 
            "Güneş Sistemi Maketi", "Günlük Konuşma Diyalogları", "Halat", "Hikaye Kitapları", "Huni", "İğne", 
            "İletki", "İp", "İplik", "İskelet Modeli", "Jenga", "Jimnastik minderi", "Kakuro", "Kalem", "Kasnak", 
            "Kaynak Ekipmanları", "Keçe", "Kelime avı", "Kıl Testere", "Kişisel Bakım Ekipmanları", "Kitap", 
            "Koşu Bandı", "Krokiler, Haritalar", "Kumaş", "Küre", "Makas", "Mangala", "Mantık karesi", "Markalama Aletleri", 
            "Mekanik ayırma bilmeceleri", "Melodika", "Metal Ritim Kaşıkları", "Mevsim Şeridi", "Mıknatıs", "Mikroskop", 
            "Mutfak Ekipmanları", "Okuma Metinleri", "Olay Sıralama Kartları", "Onluk Taban Blokları", "Orff Çalgılar", 
            "Oyun Hamuru", "Örüntü Blokları", "Pergel", "Pipet", "Piyano", "Plates Topu", "Poster", "Raket", 
            "Renkli Notalar", "Resim hatırlama", "Resimli Kartlar", "Ritim Çubukları", "Satranç", "Sayı Çubukları", 
            "Scrabble", "Servis Ekipmanları", "Sıralı Kartlar", "Sözcük gruplama", "Sözlük", "Step tahtası", "Sudoku", 
            "Şifre oyunları", "Şiş", "Tablo ve Grafikler", "Takı Malzemeleri", "Tangram", "Tarih şeridi", "Temizlik Ekipmanları", 
            "Temrin gereçler", "Tığ", "Top", "Trambolin", "Tutkal", "Üç ampül", "Videolar", "Vücudumuz Maketi", "Yap bozlar", 
            "Yapıştırıcı", "Yün", "Yürüyüş Bandı"
        ];
        
        // Örnek Müfredat (Güncellenmiş 1. Sınıf Verileri ile)
        const MUFREDAT = {
            "1": {
                "Türkçe": [
                    { 
                        uda: "Temel dinleme ve izleme becerilerini kullanarak anlam oluşturur.", 
                        kda: [
                            "Dinlediği sesin kaynağını (doğal veya yapay) tahmin ederek söyler.",
                            "Dinleme esnasında konuşmaya dâhil olmak için uygun zamanda söz alır.",
                            "Görsellerden hareketle dinleyeceği/izleyeceği metnin konusu hakkında tahminde bulunur.",
                            "Dinlediklerini/izlediklerini kendi yaşantısı ve ön bilgileriyle karşılaştırarak çıkarımlarda bulunur."
                        ] 
                    },
                    { 
                        uda: "Temel okuma becerilerini kazanır ve geliştirir.", 
                        kda: [
                            "Öğrenilen seslere karşılık gelen harfleri tanır ve diğerlerinden ayırt eder.",
                            "Harf ve heceleri doğru seslendirerek okur.",
                            "Öğrendiği seslerden oluşan sözcük ve cümleleri işitilebilir bir ses düzeyinde okur.",
                            "Okuduğu metnin konusunu ve ana fikrini belirler."
                        ] 
                    },
                    { 
                        uda: "Yazılı anlatım becerilerini yönetir ve içerik oluşturur.", 
                        kda: [
                            "Yazma materyallerini (kalem, defter) kuralına uygun kullanır.",
                            "Harfleri ve rakamları temel formuna ve yazım yönlerine uygun olarak yazar.",
                            "Hece, sözcük ve cümleler arasında uygun boşluk bırakarak yazar.",
                            "Görsellerle ilgili basit sözcük ve cümleler yazar.",
                            "Yazılarında temel noktalama işaretlerini (nokta, kesme işareti, soru işareti) kuralına uygun kullanır."
                        ] 
                    },
                    { 
                        uda: "Sözlü iletişim (konuşma) becerilerini etkili bir şekilde kullanır.", 
                        kda: [
                            "Öğrendiği hece, sözcük ve cümleleri doğru telaffuz ederek söyler.",
                            "Dinlediği veya izlediği bir metni ana hatlarıyla anlatır.",
                            "Konuşmalarında nezaket ifadelerini ve hitap sözlerini yerinde kullanır."
                        ] 
                    },
                    { 
                        uda: "Okuma ve yazma süreçlerini değerlendirir ve geliştirir.", 
                        kda: [
                            "Yazılarındaki hataları (harf eksikliği, yazım yanlışı vb.) fark eder ve düzeltir.",
                            "Okuma ve dinleme sürecindeki olumlu davranışlarını bir sonraki çalışmasına aktarır."
                        ] 
                    }
                ],
                "Matematik": [
                    { 
                        uda: "Nesnelerin geometrisi ve uzamsal ilişkiler konusunda temel beceriler sergiler.", 
                        kda: [
                            "Hedefe ulaşmak için mesafe ve yön içeren (önünde, arkasında, sağında, solunda vb.) yönergeleri çözümler.",
                            "Nesnelerin eşliğini (boyut, renk, biçim) belirlediği bir ölçüte göre değerlendirir.",
                            "Geometrik şekilleri (üçgen, kare, dikdörtgen, çember) tanır ve çevrelerindeki nesnelerle ilişkilendirir."
                        ] 
                    },
                    { 
                        uda: "Sayılar ve nicelikler arasındaki ilişkileri kavrayarak temel sayma becerilerini kullanır.", 
                        kda: [
                            "20’ye kadar olan sayıları (20 dâhil) ve rakamları nesne gruplarının büyüklüklerini temsil etmek için kullanır.",
                            "Dağınık veya düzenli bir nesne grubunu sayarken parçalar arasındaki ilişkileri belirler.",
                            "Nesnelerin sıra sayısını (birinci, ikinci vb.) göstererek ifade eder.",
                            "İki niceliğin büyüklüğünü “çok”, “daha çok”, “az”, “daha az” veya “eşit” terimleriyle karşılaştırır.",
                            "20 içindeki sayıları 'onluk' ve 'birlik' yapılarına ayırarak modellerle gösterir."
                        ] 
                    },
                    { 
                        uda: "İşlemlerden cebirsel düşünmeye geçiş süreçlerini uygular.", 
                        kda: [
                            "Toplama ve çıkarma işlemlerinin anlamını günlük yaşam durumlarıyla ilişkilendirir.",
                            "20’ye kadar olan sayılarla eldesiz toplama ve onluk bozma gerektirmeyen çıkarma işlemlerini yapar.",
                            "Verilen bir sayı örüntüsündeki kuralı fark eder ve örüntüyü devam ettirir."
                        ] 
                    },
                    { 
                        uda: "Ölçme (uzunluk, paralarımız, zaman) ile ilgili temel problemleri çözer.", 
                        kda: [
                            "Nesnelerin uzunluklarını standart olmayan birimlerle (karış, adım vb.) karşılaştırır ve ölçer.",
                            "Paralarımızı (Kuruş ve Türk Lirası) tanır ve temel alışveriş durumlarında kullanır.",
                            "Zaman ölçme birimlerini (gün, hafta, ay, mevsim) tanır ve tam/yarım saatleri okur."
                        ] 
                    },
                    { 
                        uda: "Veriye dayalı araştırma sürecini yönetir.", 
                        kda: [
                            "Günlük yaşamla ilgili bir araştırma sorusu oluşturur ve basit veriler toplar.",
                            "Topladığı verileri çetele veya sıklık tablosu kullanarak görselleştirir.",
                            "Oluşturduğu nesne grafiğini veya tabloları yorumlayarak araştırma sonuçlarını açıklar."
                        ] 
                    }
                ],
                "Hayat Bilgisi": [
                    { 
                        uda: "Okul ortamına uyum sağlar ve temel iletişim becerilerini geliştirir.", 
                        kda: [
                            "Öğretmeni ve arkadaşları kendilerini tanıtırken onları etkin bir şekilde dinler.",
                            "Kendini tanıtırken çevresiyle sözlü ve sözsüz etkileşim kurar.",
                            "Sınıfını, okulunun bölümlerini ve okul çalışanlarını fark ederek gözlemlerini ifade eder.",
                            "Sınıf ve okul ortamındaki temel kuralları fark eder.",
                            "Belirlenen sınıf ve okul kurallarına uygun davranışlar sergiler.",
                            "Temel fiziksel özelliklerini ve mutluluk, üzüntü gibi temel duygularını açıklar."
                        ] 
                    },
                    { 
                        uda: "Sağlıklı yaşam ve güvenlik kurallarına uygun davranır.", 
                        kda: [
                            "Sağlıklı büyüme ve gelişme için yapması gerekenleri (beslenme, uyku vb.) belirler.",
                            "Kişisel alanının sınırlarını belirleyerek bu sınırlara uygun hareket eder.",
                            "Temel trafik kurallarına (yaya geçidi, trafik ışıkları vb.) uygun davranır.",
                            "Acil durumlarda (yangın, deprem vb.) yapılması gerekenleri ve aranacak numaraları belirler."
                        ] 
                    },
                    { 
                        uda: "Aile yapısını ve evdeki sorumluluklarını kavrar.", 
                        kda: [
                            "Aile olmanın önemini fark eder.",
                            "Aile yaşamında nezaket ve görgü kurallarına uygun ifadeler kullanır.",
                            "Ev içerisinde kendine verilen temel görev ve sorumlulukları yerine getirir."
                        ] 
                    },
                    { 
                        uda: "Yaşadığı çevreyi, ülkesini ve kültürel değerlerini tanır.", 
                        kda: [
                            "Yaşadığı yerin (köy, ilçe, il vb.) temel özelliklerini fark eder.",
                            "Yaşadığı yerdeki tarihi, doğal ve turistik yerleri belirler.",
                            "Türk bayrağının ve İstiklâl Marşı’nın vatanı için önemini kavrar.",
                            "Millî ve dini bayramlar ile belirli günlerin önemini kavrar.",
                            "Farklı kültürlerden gelen insanların yaşam şekillerine ve alışkanlıklarına saygı duyar."
                        ] 
                    },
                    { 
                        uda: "Doğa ve çevreye karşı duyarlılık geliştirir.", 
                        kda: [
                            "Yakın çevresindeki hayvanların ve bitkilerin yaşam süreçlerini gözlemler.",
                            "Doğayı ve çevreyi korumak için üzerine düşen sorumlulukları yerine getirir.",
                            "Geri dönüşümün önemini kavrar ve atıkları uygun şekilde ayrıştırır.",
                            "Mevsimlerin özelliklerini ve insan yaşamı üzerindeki etkilerini açıklar."
                        ] 
                    },
                    { 
                        uda: "Bilim, teknoloji ve sanatla ilgili temel farkındalık kazanır.", 
                        kda: [
                            "Bilim ve teknoloji alanında merak ettiği konularla ilgili sorular sorar.",
                            "Günlük yaşamda kullanılan teknolojik araçların güvenli kullanımı hakkında bilgi sahibi olur.",
                            "Sanatın ve sanatsal faaliyetlerin günlük yaşamdaki yerini fark eder."
                        ] 
                    }
                ],
                "Beden Eğitimi ve Oyun": [
                    { 
                        uda: "Oyunlarda temel hareket kavramlarını ve güvenli uygulama becerilerini sergiler.", 
                        kda: [
                            "Beden farkındalığı, alan farkındalığı, efor ve hareket ilişkileri kavramlarını birbirinden ayırt eder.",
                            "Hareket ile beden ve alan farkındalığı gibi temel kavramlar arasında bağ kurar.",
                            "Oyunlar sırasında ortaya çıkabilecek riskleri tanımlayarak bu risklere karşı önleyici tedbirler alır."
                        ] 
                    },
                    { 
                        uda: "Temel hareket becerilerini farklı durumlarda ve oyunlarda sergiler.", 
                        kda: [
                            "Yer değiştirme, nesne kontrolü ve denge becerilerini algılar ve bu becerilerin basamaklarını gösterir.",
                            "Temel hareket becerilerini (yer değiştirme, nesne kontrolü, denge) oyunlar içerisinde ve farklı durumlarda uygular."
                        ] 
                    },
                    { 
                        uda: "Oyun kurallarına, taktiklere ve adil oyun anlayışına uygun hareket eder.", 
                        kda: [
                            "Katıldığı oyunlarda belirlenen oyun kurallarına eksiksiz uyar.",
                            "Oyunlar sırasında basit taktik ve stratejileri kullanarak hedefe yönelik hareket eder.",
                            "Adil oyun anlayışını açıklar ve oyunlarda bu anlayışa uygun davranışlar sergiler."
                        ] 
                    },
                    { 
                        uda: "Ritmik hareket becerilerini sergiler.", 
                        kda: [
                            "Temel hareket becerilerini kullanarak verilen bir ritmi algılar.",
                            "Verilen ritme uygun hareket eder ve ritmik hareket becerilerini grup veya bireysel olarak sergiler."
                        ] 
                    },
                    { 
                        uda: "Fiziksel aktiviteye katılım sağlar ve sağlıklı yaşam bilinci geliştirir.", 
                        kda: [
                            "Fiziksel aktivite düzeyini fark eder ve bu düzeyi geliştirmek için basit bir plan yapar.",
                            "Hazırladığı fiziksel aktivite planını okul içi ve dışı ortamlarda uygular.",
                            "Sağlıklı büyüme ve gelişme ile fiziksel aktivite arasındaki ilişkiyi açıklar."
                        ] 
                    }
                ]
            },
            "2": { "Türkçe": [], "Matematik": [], "Hayat Bilgisi": [] },
            "3": { "Türkçe": [], "Matematik": [], "Fen Bilimleri": [], "Hayat Bilgisi": [] },
            "4": { "Türkçe": [], "Matematik": [], "Fen Bilimleri": [], "Sosyal Bilgiler": [] }
        };

        // --- GLOBAL DEĞİŞKENLER ---
        let bepPlani = [];

        // --- BAŞLANGIÇ ---
        document.addEventListener('DOMContentLoaded', () => {
            tarihAta('tam');
            listeleriHazirla();
            veriYukle();
        });
        
        // --- UYGULAMAYI BAŞLAT ---
        function uygulamayiBaslat() {
            const overlay = document.getElementById('welcomeOverlay');
            overlay.classList.add('opacity-0', 'pointer-events-none', 'scale-110');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
        }

        // --- ACCORDION LOGIC ---
        function toggleAccordion(id, iconId) {
            const el = document.getElementById(id);
            const icon = document.getElementById(iconId);
            el.classList.toggle('open');
            if(icon) {
                icon.style.transform = el.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }

        // --- LİSTE HAZIRLAMA FONKSİYONLARI ---
        function listeleriHazirla() {
            createMultiSelectList('yontemDropdown', OGRETIM_YONTEMLERI, 'yontemOzet', ['Anlatım Yöntemi', 'Soru Cevap Tekniği']);
            createMultiSelectList('aracDropdown', ARAC_GERECLER, 'aracOzet', ['Ders Kitabı', 'Defter']);
            createMultiSelectList('degerlendirmeDropdown', DEGERLENDIRME_YONTEMLERI, 'degerlendirmeOzet', ['Gözlem Formu', 'Kontrol Listesi']);
        }

        function createMultiSelectList(containerId, items, summaryId, defaults = []) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // Arama Kutusu
            const searchDiv = document.createElement('div');
            searchDiv.className = "p-2 border-b border-slate-100 sticky top-0 bg-white";
            searchDiv.innerHTML = `<input type="text" placeholder="Ara..." class="w-full text-xs p-1 border rounded" onkeyup="filterList(this, '${containerId}')">`;
            container.appendChild(searchDiv);

            // Liste Elemanları
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = "flex items-center px-3 py-2 hover:bg-slate-50 cursor-pointer border-b border-slate-50 last:border-0";
                const isChecked = defaults.some(def => item.includes(def));
                div.innerHTML = `
                    <input type="checkbox" value="${item}" ${isChecked ? 'checked' : ''} onchange="updateSummary('${containerId}', '${summaryId}')" class="w-4 h-4 text-mebBlue rounded border-slate-300 focus:ring-mebBlue mr-2">
                    <span class="text-xs text-slate-700 select-none" onclick="this.previousElementSibling.click()">${item}</span>
                `;
                container.appendChild(div);
            });
            updateSummary(containerId, summaryId);
        }

        function toggleDropdown(id) {
            const el = document.getElementById(id);
            // Diğer açık olanları kapat
            document.querySelectorAll('.multi-select-dropdown.open').forEach(d => {
                if(d.id !== id) d.classList.remove('open');
            });
            el.classList.toggle('open');
        }

        function filterList(input, containerId) {
            const filter = input.value.toLowerCase();
            const container = document.getElementById(containerId);
            const divs = container.querySelectorAll('div.flex');
            divs.forEach(div => {
                const txt = div.innerText.toLowerCase();
                div.style.display = txt.includes(filter) ? "" : "none";
            });
        }

        function updateSummary(containerId, summaryId) {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            const summaryEl = document.getElementById(summaryId);
            const values = Array.from(checkboxes).map(cb => cb.value);
            
            if (values.length === 0) {
                summaryEl.innerText = "Seçiniz...";
                summaryEl.classList.add("text-slate-400");
            } else {
                summaryEl.innerText = values.join(", ");
                summaryEl.classList.remove("text-slate-400");
            }
        }

        function getSelectedValues(containerId) {
            const container = document.getElementById(containerId);
            return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }

        // --- FORM İŞLEMLERİ ---
        function toggleManualInput(selectId, inputId) {
            const val = document.getElementById(selectId).value;
            const input = document.getElementById(inputId);
            if (val === 'Diğer') {
                input.classList.remove('hidden');
                input.focus();
                // Eğer UDA ise KDA manuel alanını da aç
                if (selectId === 'udaSecimi') {
                    document.getElementById('kdaListesi').classList.add('hidden');
                    document.getElementById('tumunuSecContainer').classList.add('hidden');
                    document.getElementById('kdaManuel').classList.remove('hidden');
                }
            } else {
                input.classList.add('hidden');
                // Eğer UDA ise KDA listesini geri getir
                if (selectId === 'udaSecimi') {
                    document.getElementById('kdaListesi').classList.remove('hidden');
                    document.getElementById('tumunuSecContainer').classList.remove('hidden');
                    document.getElementById('kdaManuel').classList.add('hidden');
                }
            }
        }

        function tarihAta(tip) {
            const now = new Date();
            const yil = now.getMonth() > 6 ? now.getFullYear() : now.getFullYear() - 1;
            const basEl = document.getElementById('basTarih');
            const bitEl = document.getElementById('bitTarih');
            
            if (tip === 'tam') {
                basEl.value = `${yil}-09-15`;
                bitEl.value = `${yil+1}-06-15`;
            }
        }

        // --- DERS VE HEDEF LOGIC ---
        function dersleriGetir() {
            const sinif = document.getElementById('sinifSecimi').value;
            const dersSelect = document.getElementById('dersSecimi');
            dersSelect.innerHTML = '<option value="">Ders Seçiniz...</option>';
            
            // UI Temizliği (Accordion kapama)
            document.getElementById('udaContainer').classList.remove('open');
            document.getElementById('detayAyarlari').classList.remove('open');
            document.getElementById('kdaContainer').classList.remove('open');
            
            document.getElementById('bosMesaj').classList.remove('hidden'); // Geri getir ama opacity ile oynayabiliriz

            if (sinif && MUFREDAT[sinif]) {
                dersSelect.disabled = false;
                Object.keys(MUFREDAT[sinif]).forEach(ders => {
                    const opt = document.createElement('option');
                    opt.value = ders;
                    opt.text = ders;
                    dersSelect.appendChild(opt);
                });
            } else {
                dersSelect.disabled = true;
            }
        }

        function udalariGetir() {
            const sinif = document.getElementById('sinifSecimi').value;
            const ders = document.getElementById('dersSecimi').value;
            const udaSelect = document.getElementById('udaSecimi');
            
            if (sinif && ders) {
                document.getElementById('bosMesaj').classList.add('hidden');
                
                // Yumuşak açılış
                document.getElementById('udaContainer').classList.add('open');
                document.getElementById('detayAyarlari').classList.add('open');
                
                udaSelect.innerHTML = '<option value="">Hedef seçiniz...</option>';
                // Müfredattan yükle
                if (MUFREDAT[sinif][ders]) {
                    MUFREDAT[sinif][ders].forEach((item, index) => {
                        const opt = document.createElement('option');
                        opt.value = index;
                        opt.text = item.uda;
                        udaSelect.appendChild(opt);
                    });
                }
                // Manuel seçenek
                const manuelOpt = document.createElement('option');
                manuelOpt.value = "Diğer";
                manuelOpt.text = "Diğer (Elle Giriniz)";
                udaSelect.appendChild(manuelOpt);
            }
        }

        function kdalariGetir() {
            const val = document.getElementById('udaSecimi').value;
            const kdaContainer = document.getElementById('kdaContainer');
            
            if (val === "") {
                kdaContainer.classList.remove('open');
                return;
            }

            kdaContainer.classList.add('open');
            
            // Manuel Giriş Kontrolü
            if (val === "Diğer") {
                toggleManualInput('udaSecimi', 'udaManuel');
                return; 
            } else {
                toggleManualInput('udaSecimi', 'udaManuel'); // Kapatır
            }

            const sinif = document.getElementById('sinifSecimi').value;
            const ders = document.getElementById('dersSecimi').value;
            const kdaListesi = document.getElementById('kdaListesi');
            
            kdaListesi.innerHTML = '';
            document.getElementById('tumunuSec').checked = false;

            const kazanimlar = MUFREDAT[sinif][ders][val].kda;
            kazanimlar.forEach(kda => {
                const div = document.createElement('div');
                div.className = "flex items-start p-1 hover:bg-white rounded";
                div.innerHTML = `
                    <input type="checkbox" value="${kda}" class="checkbox-wrapper w-4 h-4 mt-1 text-mebRed rounded border-slate-300 focus:ring-mebRed mr-2">
                    <span class="text-xs text-slate-700 cursor-pointer" onclick="this.previousElementSibling.click()">${kda}</span>
                `;
                kdaListesi.appendChild(div);
            });
        }

        function tumKdaSec() {
            const chk = document.getElementById('tumunuSec').checked;
            document.querySelectorAll('#kdaListesi input[type="checkbox"]').forEach(cb => cb.checked = chk);
        }

        // --- PLAN EKLEME VE YÖNETME ---
        function planaEkle() {
            // Validasyon
            const sinif = document.getElementById('sinifSecimi').value;
            const ders = document.getElementById('dersSecimi').value;
            const udaSelect = document.getElementById('udaSecimi');
            let udaText = "";
            let kdaList = [];

            if (!sinif || !ders || !udaSelect.value) {
                showToast("Lütfen tüm alanları seçiniz.");
                return;
            }

            // UDA Belirleme
            if (udaSelect.value === "Diğer") {
                udaText = document.getElementById('udaManuel').value.trim();
                const manuelKdaText = document.getElementById('kdaManuel').value.trim();
                if (!udaText) { showToast("Lütfen hedef yazınız."); return; }
                if (manuelKdaText) {
                    kdaList = manuelKdaText.split('\n').filter(line => line.trim() !== "");
                }
            } else {
                udaText = udaSelect.options[udaSelect.selectedIndex].text;
                document.querySelectorAll('#kdaListesi input:checked').forEach(cb => kdaList.push(cb.value));
            }

            if (kdaList.length === 0) {
                showToast("En az bir kazanım (KDA) belirlemelisiniz.");
                return;
            }
            
            // --- DUPLICATE UDA KONTROLÜ (YENİ) ---
            const mevcut = bepPlani.find(p => p.ders === ders && p.uda === udaText);
            if (mevcut) {
                alert(`Bu ders için "${udaText}" hedefi zaten eklenmiş. Lütfen farklı bir hedef seçiniz.`);
                return;
            }

            // Ayarları al
            const yontemler = getSelectedValues('yontemDropdown');
            const araclar = getSelectedValues('aracDropdown');
            const degerlendirme = getSelectedValues('degerlendirmeDropdown');
            const olcut = document.getElementById('olcutSecimi').value;

            // Objeyi oluştur
            const planItem = {
                id: Date.now(),
                sinif,
                ders,
                uda: udaText,
                kdaList,
                yontemler: yontemler.length > 0 ? yontemler : ["Anlatım", "Soru-Cevap"],
                araclar: araclar.length > 0 ? araclar : ["Ders Kitabı"],
                degerlendirme: degerlendirme.length > 0 ? degerlendirme : ["Gözlem Formu"],
                olcut
            };

            bepPlani.push(planItem);
            planiGuncelle();
            verileriKaydet();
            showToast("Hedef plana eklendi!");
        }

        function planiGuncelle() {
            const liste = document.getElementById('planListesi');
            const sayac = document.getElementById('hedefSayisi');
            const istatistikKutusu = document.getElementById('istatistikKutusu');
            sayac.innerText = bepPlani.length;
            
            // İstatistikleri Hesapla
            const istatistik = {};
            bepPlani.forEach(p => istatistik[p.ders] = (istatistik[p.ders] || 0) + 1);

            // İstatistik Kutusunu Güncelle
            if (Object.keys(istatistik).length > 0) {
                istatistikKutusu.innerHTML = '';
                Object.keys(istatistik).forEach(ders => {
                    const row = document.createElement('div');
                    row.className = "flex justify-between border-b pb-1 last:border-0";
                    row.innerHTML = `<span>${ders}</span> <span class="font-bold text-mebBlue">${istatistik[ders]} Hedef</span>`;
                    istatistikKutusu.appendChild(row);
                });
            } else {
                istatistikKutusu.innerHTML = '<div class="text-slate-400 italic">Veri yok.</div>';
            }

            if (bepPlani.length === 0) {
                liste.innerHTML = '<div class="text-center py-8 text-slate-400 text-xs italic">Henüz hedef eklenmedi.</div>';
                return;
            }

            liste.innerHTML = '';
            bepPlani.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white border border-slate-200 rounded-lg p-3 shadow-sm hover:shadow-md transition group relative";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="inline-block px-2 py-0.5 bg-blue-50 text-blue-700 text-[10px] font-bold rounded">${item.ders}</span>
                        <div class="flex gap-2">
                             <button onclick="planiDuzenle(${item.id})" class="text-slate-400 hover:text-blue-600 text-xs" title="Düzenle"><i class="fas fa-edit"></i></button>
                             <button onclick="planiSil(${item.id})" class="text-slate-400 hover:text-red-600 text-xs" title="Sil"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <p class="text-xs font-bold text-slate-700 mb-1 line-clamp-2">${item.uda}</p>
                    <p class="text-[10px] text-slate-500">${item.kdaList.length} adet kazanım</p>
                `;
                liste.appendChild(div);
            });
        }

        function planiSil(id) {
            if(confirm("Bu hedefi silmek istediğinize emin misiniz?")) {
                bepPlani = bepPlani.filter(p => p.id !== id);
                planiGuncelle();
                verileriKaydet();
            }
        }

        function planiDuzenle(id) {
            const item = bepPlani.find(p => p.id === id);
            if (!item) return;

            // Formu doldur
            document.getElementById('sinifSecimi').value = item.sinif;
            dersleriGetir(); // Dersleri yükle
            document.getElementById('dersSecimi').value = item.ders;
            udalariGetir(); // Hedefleri yükle

            // UDA'yı bulmaya çalış
            const udaSelect = document.getElementById('udaSecimi');
            let found = false;
            for(let i=0; i<udaSelect.options.length; i++) {
                if (udaSelect.options[i].text === item.uda) {
                    udaSelect.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            if (!found) {
                udaSelect.value = "Diğer";
                toggleManualInput('udaSecimi', 'udaManuel');
                document.getElementById('udaManuel').value = item.uda;
                // Manuel KDA'ları yükle
                document.getElementById('kdaManuel').value = item.kdaList.join('\n');
            } else {
                kdalariGetir();
                // Checkboxları işaretle
                setTimeout(() => {
                    item.kdaList.forEach(kda => {
                        const cb = document.querySelector(`#kdaListesi input[value="${kda}"]`);
                        if(cb) cb.checked = true;
                    });
                }, 100);
            }

            // Seçim listelerini ayarla (Basitçe yeniden oluşturarak)
            createMultiSelectList('yontemDropdown', OGRETIM_YONTEMLERI, 'yontemOzet', item.yontemler);
            createMultiSelectList('aracDropdown', ARAC_GERECLER, 'aracOzet', item.araclar);
            createMultiSelectList('degerlendirmeDropdown', DEGERLENDIRME_YONTEMLERI, 'degerlendirmeOzet', item.degerlendirme);
            document.getElementById('olcutSecimi').value = item.olcut;

            // Listeden sil
            bepPlani = bepPlani.filter(p => p.id !== id);
            planiGuncelle();
            showToast("Hedef düzenleme için yüklendi.");
        }

        // --- VERİ YÖNETİMİ ---
        function verileriKaydet() {
            const data = {
                ogrenci: {
                    okul: document.getElementById('okulAd').value,
                    ad: document.getElementById('ogrAd').value,
                    sinif: document.getElementById('ogrSinif').value,
                    no: document.getElementById('ogrNo').value,
                    tani: document.getElementById('taniSecimi').value,
                    taniManuel: document.getElementById('taniManuel').value,
                    basTarih: document.getElementById('basTarih').value,
                    bitTarih: document.getElementById('bitTarih').value,
                    performans: document.getElementById('ogrPerf').value
                },
                kurul: {
                    mudur: document.getElementById('mudurAd').value,
                    rehber: document.getElementById('rehberAd').value,
                    sinifOgr: document.getElementById('sinifOgretmenAd').value,
                    veli: document.getElementById('veliAd').value
                },
                plan: bepPlani
            };
            localStorage.setItem('bepDataV8', JSON.stringify(data));
        }

        function veriYukle() {
            const dataStr = localStorage.getItem('bepDataV8');
            if (!dataStr) return;
            try {
                const data = JSON.parse(dataStr);
                document.getElementById('okulAd').value = data.ogrenci.okul || "";
                document.getElementById('ogrAd').value = data.ogrenci.ad || "";
                document.getElementById('ogrSinif').value = data.ogrenci.sinif || "";
                document.getElementById('ogrNo').value = data.ogrenci.no || "";
                document.getElementById('taniSecimi').value = data.ogrenci.tani || "";
                if (data.ogrenci.tani === "Diğer") {
                    toggleManualInput('taniSecimi', 'taniManuel');
                    document.getElementById('taniManuel').value = data.ogrenci.taniManuel || "";
                }
                document.getElementById('basTarih').value = data.ogrenci.basTarih || "";
                document.getElementById('bitTarih').value = data.ogrenci.bitTarih || "";
                document.getElementById('ogrPerf').value = data.ogrenci.performans || "";
                
                document.getElementById('mudurAd').value = data.kurul.mudur || "";
                document.getElementById('rehberAd').value = data.kurul.rehber || "";
                document.getElementById('sinifOgretmenAd').value = data.kurul.sinifOgr || "";
                document.getElementById('veliAd').value = data.kurul.veli || "";

                bepPlani = data.plan || [];
                planiGuncelle();
            } catch (e) {
                console.error("Veri yükleme hatası", e);
            }
        }

        function verileriTemizle() {
            if(confirm("Tüm veriler silinecek ve sayfa yenilenecek. Onaylıyor musunuz?")) {
                localStorage.removeItem('bepDataV8');
                window.location.reload();
            }
        }

        function verileriYedekle() {
            verileriKaydet();
            const dataStr = localStorage.getItem('bepDataV8');
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `BEP_${document.getElementById('ogrAd').value || 'Ogrenci'}_${new Date().toLocaleDateString('tr-TR')}.json`;
            a.click();
        }

        function dosyadanYukle(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                localStorage.setItem('bepDataV8', e.target.result);
                veriYukle();
                showToast("Yedek başarıyla yüklendi.");
            };
            reader.readAsText(file);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            t.classList.remove('-translate-y-24', 'opacity-0');
            setTimeout(() => {
                t.classList.add('-translate-y-24', 'opacity-0');
            }, 3000);
        }

        // --- OTOMATİK İŞLEMLER ---
        function otomatikPerformansOlustur() {
            if (bepPlani.length === 0) { showToast("Önce hedef ekleyiniz."); return; }
            const ad = titleCase(document.getElementById('ogrAd').value) || "Öğrenci";
            let metin = `Öğrencimiz ${ad} ile yapılan kaba değerlendirme çalışmaları ve sınıf içi gözlemler neticesinde;\n\n`;
            
            // Dersleri grupla
            const gruplar = {};
            bepPlani.forEach(p => {
                if(!gruplar[p.ders]) gruplar[p.ders] = [];
                gruplar[p.ders].push(p);
            });

            Object.keys(gruplar).forEach(ders => {
                const planlar = gruplar[ders];
                const udaListesi = planlar.map(p => p.uda.replace(/^[A-Z]\.\d+\.\s*/, '').trim()).join(', ');
                
                metin += `${ders} dersinde, özellikle "${udaListesi}" konularında akademik ve işlevsel desteğe ihtiyaç duyduğu tespit edilmiştir.\n`;
                metin += `Bu bağlamda, öğrencinin bireysel gelişim hızı ve öğrenme stili dikkate alınarak hazırlanan bu planda, ${ders} dersi için toplam ${planlar.reduce((acc, curr) => acc + curr.kdaList.length, 0)} adet kazanım üzerine yoğunlaşılması hedeflenmiştir.\n\n`;
            });
            
            document.getElementById('ogrPerf').value = metin;
        }

        // --- YAZDIRMA MANTIĞI ---
        function titleCase(str) {
            if (!str) return "";
            return str.toLocaleLowerCase('tr-TR').split(' ').map(word => word.charAt(0).toLocaleUpperCase('tr-TR') + word.slice(1)).join(' ');
        }
        
        function formatSinif(str) {
            if (!str) return "";
            return str.replace(/^(\d+)\s*[-/]?\s*([a-zA-Z])$/, (match, p1, p2) => {
                return `${p1}/${p2.toLocaleUpperCase('tr-TR')}`;
            });
        }
        
        function tarihFormatla(tarihStr) {
            if (!tarihStr) return "...../...../..........";
            const d = new Date(tarihStr);
            return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth()+1).toString().padStart(2, '0')}/${d.getFullYear()}`;
        }

        // --- ZORUNLU ALAN KONTROLÜ (YENİ) ---
        function tamamlaVeYazdirKontrol() {
            if (bepPlani.length === 0) { alert("Lütfen en az bir hedef ekleyin."); return; }
            
            // Zorunlu alanları kontrol et
            const requiredIds = ['okulAd', 'ogrAd', 'ogrSinif', 'taniSecimi', 'mudurAd', 'rehberAd', 'sinifOgretmenAd', 'veliAd']; // ogrNo çıkarıldı
            let hasError = false;
            
            // Önceki hataları temizle
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

            requiredIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value.trim()) {
                    el.classList.add('input-error');
                    hasError = true;
                    // Eğer kurul üyelerindeyse accordion'u aç
                    if(['mudurAd', 'rehberAd', 'sinifOgretmenAd', 'veliAd'].includes(id)) {
                        const kurulBody = document.getElementById('kurulBody');
                        if (!kurulBody.classList.contains('open')) {
                            toggleAccordion('kurulBody', 'kurulIcon');
                        }
                    }
                }
            });

            if (hasError) {
                showToast("Lütfen zorunlu alanları doldurunuz.");
                // İlk hatalı elemana scroll
                const firstError = document.querySelector('.input-error');
                if(firstError) firstError.scrollIntoView({behavior: 'smooth', block: 'center'});
                return;
            }

            const perf = document.getElementById('ogrPerf').value.trim();
            if (!perf) {
                if(confirm("Eğitsel Performans alanı boş. Seçtiğiniz hedeflere göre otomatik doldurulmasını ister misiniz?")) {
                    otomatikPerformansOlustur();
                    verileriKaydet(); // Kaydet ki yazdırırken görünsün
                }
            }
            
            yazdirmaOnizlemeHazirla();
            setTimeout(() => window.print(), 500);
        }

        function yazdirmaOnizlemeHazirla() {
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = '';

            // Verileri Al ve Formatla
            const okul = titleCase(document.getElementById('okulAd').value) || ".......................................................";
            const ogrAd = titleCase(document.getElementById('ogrAd').value);
            const ogrNo = document.getElementById('ogrNo').value;
            const sinif = formatSinif(document.getElementById('ogrSinif').value) || document.getElementById('ogrSinif').value;
            const tani = (document.getElementById('taniSecimi').value === 'Diğer') ? titleCase(document.getElementById('taniManuel').value) : document.getElementById('taniSecimi').value;
            const tarihAraligi = `${tarihFormatla(document.getElementById('basTarih').value)} - ${tarihFormatla(document.getElementById('bitTarih').value)}`;
            const performans = document.getElementById('ogrPerf').value;

            // İmza İsimleri
            const mudur = titleCase(document.getElementById('mudurAd').value);
            const rehber = titleCase(document.getElementById('rehberAd').value);
            const sinifOgr = titleCase(document.getElementById('sinifOgretmenAd').value);
            const veli = titleCase(document.getElementById('veliAd').value);

            // Dersleri Grupla (Her ders ayrı sayfa)
            const dersGruplari = {};
            bepPlani.forEach(p => {
                if(!dersGruplari[p.ders]) dersGruplari[p.ders] = [];
                dersGruplari[p.ders].push(p);
            });

            // Her ders grubu için sayfa oluştur
            Object.keys(dersGruplari).forEach((ders, index) => {
                const planlar = dersGruplari[ders];
                const pageDiv = document.createElement('div');
                pageDiv.className = "bep-page-container page-break relative";
                
                let htmlContent = `
                    <div class="header-section">
                        <div class="header-main">T.C. MİLLİ EĞİTİM BAKANLIĞI</div>
                        <div class="header-main">${okul.toUpperCase()} MÜDÜRLÜĞÜ</div>
                        <div class="header-sub">BİREYSELLEŞTİRİLMİŞ EĞİTİM PROGRAMI (BEP)</div>
                        <div class="header-lesson">${ders.toUpperCase()} DERSİ</div>
                    </div>

                    <table class="info-table">
                        <tr>
                            <th>ÖĞRENCİ ADI</th><td>${ogrAd}</td>
                            <th>SINIF - NO</th><td>${sinif} - ${ogrNo}</td>
                        </tr>
                        <tr>
                            <th>EĞİTSEL TANI</th><td>${tani}</td>
                            <th>TARİH ARALIĞI</th><td>${tarihAraligi}</td>
                        </tr>
                    </table>

                    <div class="perf-box">
                        <div class="perf-header">EĞİTSEL PERFORMANS</div>
                        <div class="perf-content">${performans}</div>
                    </div>

                    <table class="goals-table">
                        <thead>
                            <tr>
                                <th width="25%">UZUN DÖNEMLİ AMAÇLAR</th>
                                <th width="40%">KISA DÖNEMLİ AMAÇLAR (KAZANIMLAR)</th>
                                <th width="35%">YÖNTEM / ARAÇ / DEĞERLENDİRME</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                planlar.forEach(p => {
                    htmlContent += `
                        <tr>
                            <td><b>${p.uda}</b></td>
                            <td>
                                <ul style="margin:0; padding-left:15px; list-style-type:square;">
                                    ${p.kdaList.map(k => `<li style="margin-bottom:2px;">${k}</li>`).join('')}
                                </ul>
                            </td>
                            <td>
                                <div style="margin-bottom:6px;"><b>Yöntem:</b> ${p.yontemler.join(', ')}</div>
                                <div style="margin-bottom:6px;"><b>Araç:</b> ${p.araclar.join(', ')}</div>
                                <div><b>Değ.:</b> ${p.degerlendirme.join(', ')} (${p.olcut})</div>
                            </td>
                        </tr>
                    `;
                });

                htmlContent += `
                        </tbody>
                    </table>

                    <div class="imza-bolumu">
                        <table class="imza-table">
                            <tr>
                                <td>
                                    <span class="imza-isim">${mudur}</span>
                                    <span class="imza-unvan">Okul Müdürü</span>
                                    <div class="imza-cizgi"></div>
                                </td>
                                <td>
                                    <span class="imza-isim">${sinifOgr}</span>
                                    <span class="imza-unvan">Sınıf Öğretmeni</span>
                                    <div class="imza-cizgi"></div>
                                </td>
                                <td>
                                    <span class="imza-isim">${rehber}</span>
                                    <span class="imza-unvan">Rehber Öğretmen</span>
                                    <div class="imza-cizgi"></div>
                                </td>
                                <td>
                                    <span class="imza-isim">${veli}</span>
                                    <span class="imza-unvan">Veli</span>
                                    <div class="imza-cizgi"></div>
                                </td>
                            </tr>
                        </table>
                    </div>
                `;
                
                pageDiv.innerHTML = htmlContent;
                printArea.appendChild(pageDiv);
            });
        }
    </script>
</body>
</html>
